name: Release Publish

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Busca o PR que gerou esse push
      - name: Get PR info
        id: prinfo
        uses: actions-ecosystem/action-get-merged-pull-request@v1

      - name: Extract PR info
        id: extract
        run: |
          echo "pr_number=${{ steps.prinfo.outputs.number }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ steps.prinfo.outputs.title }}" >> $GITHUB_OUTPUT
          echo "pr_body=${{ steps.prinfo.outputs.body }}" >> $GITHUB_OUTPUT
          echo "author_name=${{ steps.prinfo.outputs.author }}" >> $GITHUB_OUTPUT

      - name: Get commit list
        id: commits
        run: |
          COMMITS=$(git log -n 5 --pretty=format:"â€¢ %s")
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

      - name: Notify Slack
        run: |
          curl -X POST -H "Content-type: application/json" \
          --data "{
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {\"type\": \"plain_text\", \"text\": \"ðŸ“¦ Novo Pacote Publicado\"}
              },
              {
                \"type\": \"section\",
                \"fields\": [
                  {\"type\": \"mrkdwn\", \"text\": \"*TÃ­tulo do PR:* ${{ steps.extract.outputs.pr_title }}\"},
                  {\"type\": \"mrkdwn\", \"text\": \"*Autor:* ${{ steps.extract.outputs.author_name }}\"}
                ]
              },
              {
                \"type\": \"section\",
                \"text\": {\"type\": \"mrkdwn\", \"text\": \"*DescriÃ§Ã£o:* ${{ steps.extract.outputs.pr_body }}\"}
              },
              {
                \"type\": \"section\",
                \"text\": {\"type\": \"mrkdwn\", \"text\": \"*Commits:* \n${{ steps.commits.outputs.commits }}\"}
              },
              {
                \"type\": \"actions\",
                \"elements\": [
                  {
                    \"type\": \"button\",
                    \"text\": {\"type\": \"plain_text\", \"text\": \"Ver PR no GitHub\"},
                    \"url\": \"https://github.com/${{ github.repository }}/pull/${{ steps.extract.outputs.pr_number }}\"
                  }
                ]
              }
            ]
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
